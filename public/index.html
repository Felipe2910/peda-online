<!DOCTYPE html>
<html lang="es">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Peda Online</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<script src="/socket.io/socket.io.js"></script>
	</head>
	<body class="bg-gray-900 text-white font-sans p-4">
		<div class="max-w-2xl mx-auto">
			<h1 class="text-3xl font-bold mb-6 text-center">üçª Peda Online</h1>

			<!-- Registro -->
			<div id="registro">
				<input
					id="nombre"
					class="w-full p-2 rounded bg-gray-700 text-white mb-2"
					placeholder="Tu nombre"
				/>
				<input id="color" type="color" class="w-full p-2 mb-4" />
				<button onclick="registrar()" class="w-full bg-green-600 hover:bg-green-700 p-2 rounded">
					Registrarse
				</button>
			</div>

			<!-- Sala -->
			<div id="sala" class="hidden">
				<h2 class="text-xl font-semibold mb-2">Sala: <span id="nombreSala"></span></h2>
				<p class="mb-2">Jugadores:</p>
				<ul id="listaJugadores" class="mb-4"></ul>

				<button
					id="btnIniciar"
					onclick="iniciarPeda()"
					class="hidden bg-blue-600 hover:bg-blue-700 p-2 rounded mb-4"
				>
					Iniciar Peda
				</button>

				<div id="panelRonda" class="hidden">
					<p class="mb-2">Tiempo restante: <span id="tiempo">10</span>s</p>
					<select id="bebida" class="w-full p-2 rounded bg-gray-800 text-white mb-2">
						<option value="">Elige tu bebida</option>
					</select>
					<button
						onclick="enviarBebida()"
						class="w-full bg-yellow-500 hover:bg-yellow-600 p-2 rounded"
					>
						Tomar
					</button>
				</div>

				<div id="log" class="bg-gray-800 p-2 rounded mt-4 h-40 overflow-y-auto text-sm"></div>
			</div>
		</div>

		<script>
			const socket = io();
			let usuario = null;
			let sala = null;
			let esHost = false;
			let timer = null;

			function registrar() {
				const nombre = document.getElementById("nombre").value;
				const color = document.getElementById("color").value;
				if (!nombre) return alert("Ingresa tu nombre");

				socket.emit("registrar_usuario", { nombre, icono: color }, (u) => {
					usuario = u;
					crearSala();
				});
			}

			function crearSala() {
				const bebidas = ["Cerveza", "Tequila", "Mezcal", "Ron", "Michelada"];
				socket.emit(
					"crear_sala",
					{ tipo: "publica", bebidasSeleccionadas: bebidas },
					({ codigo, sala: datos }) => {
						sala = datos;
						esHost = true;
						mostrarSala();
					}
				);
			}

			function mostrarSala() {
				document.getElementById("registro").classList.add("hidden");
				document.getElementById("sala").classList.remove("hidden");
				document.getElementById("nombreSala").textContent = sala.codigo;
				actualizarListaJugadores();
				if (esHost) document.getElementById("btnIniciar").classList.remove("hidden");
			}

			function actualizarListaJugadores() {
				const lista = document.getElementById("listaJugadores");
				lista.innerHTML = "";
				sala.jugadores.forEach((j) => {
					const li = document.createElement("li");
					li.innerHTML = `<span style="color:${j.icono}">‚óè</span> ${j.nombre}`;
					lista.appendChild(li);
				});
			}

			function iniciarPeda() {
				socket.emit("iniciar_peda", sala.codigo);
			}

			function enviarBebida() {
				const b = document.getElementById("bebida").value;
				if (!b) return alert("Selecciona una bebida");
				socket.emit("elegir_bebida", { codigo: sala.codigo, bebida: b });
			}

			socket.on("sala_actualizada", (datos) => {
				sala = datos;
				actualizarListaJugadores();
			});

			socket.on("nueva_ronda", ({ ronda, bebidas }) => {
				document.getElementById("panelRonda").classList.remove("hidden");
				const select = document.getElementById("bebida");
				select.innerHTML = '<option value="">Elige tu bebida</option>';
				bebidas.forEach((b) => {
					const o = document.createElement("option");
					o.value = b.nombre;
					o.textContent = `${b.nombre} (${b.alcohol}¬∞)`;
					select.appendChild(o);
				});
				iniciarTemporizador();
				agregarLog(`Inicia ronda ${ronda}`);
			});

			socket.on("ganador", (jugador) => {
				agregarLog(`üéâ ¬°${jugador.nombre} es el Tremendo Ganador!`);
			});

			socket.on("todos_eliminados", () => {
				agregarLog("üòµ Todos quedaron KO. ¬°Resaca para todos!");
			});

			socket.on("sala_destruida", () => {
				alert("La sala fue eliminada por inactividad.");
				location.reload();
			});

			function iniciarTemporizador() {
				let tiempo = 10;
				const t = document.getElementById("tiempo");
				clearInterval(timer);
				timer = setInterval(() => {
					tiempo--;
					t.textContent = tiempo;
					if (tiempo <= 0) clearInterval(timer);
				}, 1000);
			}

			function agregarLog(mensaje) {
				const log = document.getElementById("log");
				const p = document.createElement("p");
				p.textContent = mensaje;
				log.appendChild(p);
				log.scrollTop = log.scrollHeight;
			}
		</script>
	</body>
</html>
